# FAIR Repository Publishing Workflow

This GitHub Actions workflow automatically publishes your WordPress plugin to a FAIR (Federated Asset Integrity Registry) repository, implementing the [FAIR Protocol](https://github.com/fairpm/fair-protocol) for decentralized package management.

## Overview

The FAIR publish workflow:
- ✅ Automatically generates and stores cryptographic keys
- ✅ Creates a decentralized identifier (DID) for your package
- ✅ Signs package artifacts for integrity verification
- ✅ Generates FAIR-compliant metadata
- ✅ Publishes to the PLC directory
- ✅ Runs automatically after releases

## How It Works

### Workflow Trigger

The workflow runs in two scenarios:

1. **Automatically after release** - Triggers when the `release.yml` workflow completes successfully (when a new tag is pushed)
2. **Manual dispatch** - Can be manually triggered from the Actions tab with an optional version parameter

### Cryptographic Keys

On first run, if keys don't exist, the workflow will:
1. Generate a **secp256k1 key pair** (rotation key) - used for DID management
2. Generate an **Ed25519 key pair** (verification key) - used for package signing
3. Automatically save these keys as encrypted GitHub secrets
4. Request a workflow re-run to complete the publishing process

### DID Creation

The workflow creates a PLC DID (Decentralized Identifier) for your package:
- Uses the generated cryptographic keys
- Submits to the PLC directory at `https://plc.directory`
- Adds a FAIR service endpoint pointing to your metadata
- Stores the DID as a secret for future use

### Package Signing and Publishing

For each release:
1. Builds a clean plugin ZIP (excludes dev files)
2. Calculates SHA-256 checksum
3. Signs the package with the verification key
4. Generates FAIR-compliant `metadata.json`
5. Uploads metadata to the GitHub release

## Setup

### Prerequisites

- A WordPress plugin with a main plugin file containing standard headers
- A GitHub repository with releases enabled
- The `release.yml` workflow (or similar) that creates releases from tags

### Installation

1. Copy the workflow files to your repository:
   ```
   .github/
   ├── scripts/
   │   └── fair/
   │       ├── create-did.php
   │       ├── generate-metadata.php
   │       ├── manage-keys.php
   │       ├── sign-artifact.php
   │       └── update-did-service.php
   └── workflows/
       └── fair-publish.yml
   ```

2. Ensure your workflow has the necessary permissions (already configured in the workflow file)

3. Push your changes to GitHub

### First Run

1. Create a new release or manually trigger the workflow
2. The workflow will automatically:
   - Generate cryptographic keys
   - Save them as secrets
   - Exit with instructions to re-run
3. Re-run the failed workflow from the Actions tab
4. The workflow will now complete successfully and:
   - Create your package DID
   - Publish to FAIR repository

## Generated Secrets

The workflow automatically creates these encrypted secrets in your repository:

| Secret Name | Purpose | Generated By |
|------------|---------|--------------|
| `FAIR_ROTATION_KEY_PRIVATE` | Private rotation key (secp256k1) | First workflow run |
| `FAIR_ROTATION_KEY_PUBLIC` | Public rotation key (secp256k1) | First workflow run |
| `FAIR_VERIFICATION_KEY_PRIVATE` | Private verification key (Ed25519) | First workflow run |
| `FAIR_VERIFICATION_KEY_PUBLIC` | Public verification key (Ed25519) | First workflow run |
| `FAIR_DID` | Package DID | After DID creation |

⚠️ **Important**: These secrets are automatically managed. Do not manually modify them unless you know what you're doing.

## Usage

### Automatic Publishing

The workflow runs automatically whenever:
- You push a new tag (e.g., `v1.0.0`)
- The `release.yml` workflow completes successfully

No manual intervention required after initial setup!

### Manual Publishing

To manually publish a specific version:

1. Go to **Actions** tab in your repository
2. Select **"Publish to FAIR Repository"** workflow
3. Click **"Run workflow"**
4. Optionally enter a version (leave empty to use latest tag)
5. Click **"Run workflow"**

## Workflow Steps

### 1. Key Management
- Checks for existing cryptographic keys
- Generates new keys if none exist
- Saves keys as repository secrets

### 2. DID Management
- Creates new PLC DID or uses existing one
- Submits to PLC directory
- Updates with FAIR service endpoint

### 3. Package Building
- Creates clean plugin ZIP archive
- Excludes development files (`.git`, `node_modules`, etc.)
- Calculates SHA-256 checksum

### 4. Artifact Signing
- Signs the package ZIP with verification key
- Generates cryptographic signature
- Ensures package integrity

### 5. Metadata Generation
- Parses plugin headers and `readme.txt`
- Generates FAIR-compliant `metadata.json`
- Includes release information, dependencies, and artifact details

### 6. Publishing
- Uploads `fair-metadata.json` to GitHub release
- Makes metadata available at predictable URL

## FAIR Metadata

The generated metadata includes:

- **Package information**: name, description, slug, license
- **Authors and security contacts**
- **Release details**: version, dependencies, requirements
- **Artifacts**: package ZIP with signature and checksum
- **Documentation sections**: changelog, description, installation, etc.

Example metadata structure:
```json
{
  "@context": "https://fair.pm/ns/metadata/v1",
  "id": "did:plc:abc123...",
  "type": "wp-plugin",
  "name": "Minimal Admin",
  "license": "GPL-2.0+",
  "releases": [
    {
      "version": "1.0.0",
      "artifacts": {
        "package": {
          "url": "https://github.com/user/repo/releases/download/v1.0.0/plugin.zip",
          "signature": "zQ3sh...",
          "checksum": "sha256:abc..."
        }
      }
    }
  ]
}
```

## Troubleshooting

### First run fails with "Keys were generated"

This is expected behavior:
1. Keys are automatically saved as secrets
2. Re-run the workflow from the Actions tab
3. It will now complete successfully

### DID not found error

If the workflow can't find `FAIR_DID`:
- This is normal on first run
- A new DID will be created automatically
- Future runs will use the stored DID

### Signature verification fails

Check that:
- Verification keys haven't been modified
- The workflow has completed successfully
- Artifact hasn't been modified after signing

### Missing plugin file error

Ensure:
- Your plugin has a main PHP file
- The file contains standard WordPress plugin headers
- The file includes `Plugin Name:` header

## File Structure

```
.github/
├── scripts/fair/          # PHP scripts for FAIR operations
│   ├── manage-keys.php    # Key generation and management
│   ├── create-did.php     # DID creation and registration
│   ├── sign-artifact.php  # Package signing
│   ├── generate-metadata.php  # Metadata generation
│   └── update-did-service.php # DID service updates
└── workflows/
    ├── fair-publish.yml   # Main FAIR publishing workflow
    └── release.yml        # GitHub release creation
```

## Security Considerations

### Private Keys
- Never commit private keys to version control
- Keys are stored as encrypted GitHub secrets
- Only accessible to workflows with appropriate permissions

### Key Rotation
If you need to rotate keys:
1. Delete the existing key secrets from repository settings
2. Re-run the workflow to generate new keys
3. Update your DID with new keys (handled automatically)

### Package Verification
Users can verify package integrity:
1. Check the signature against your verification key
2. Verify checksum of downloaded artifact
3. Validate DID authenticity via PLC directory

## Resources

- [FAIR Protocol Specification](https://github.com/fairpm/fair-protocol)
- [FAIR Repository Implementation Guide](https://github.com/fairpm/fair-protocol/blob/main/docs/implementing/repository.md)
- [PLC Directory](https://plc.directory/)
- [DID Manager Library](https://github.com/fairpm/did-manager)

## Support

For issues or questions:
- Check the workflow logs in the Actions tab
- Review the [FAIR Protocol documentation](https://github.com/fairpm/fair-protocol)
- Open an issue in your repository

## License

This workflow implementation follows the same license as your plugin project.
